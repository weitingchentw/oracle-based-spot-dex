# Overview

This project implements an oracle-based spot Decentralized Exchange (DEX) where users can swap two supported tokens based on prices from Oracles. The swap process occurs in two steps: order submission and settlement. This design prevents front-running of Oracle price updates.

The project includes smart contracts, a frontend, and a subgraph, designed for deployment on Base's Sepolia testnet. It can be used to create a simulation trading competition with market-impacting news events.

# Prerequisites

- [Node.js](https://nodejs.org/en) (v14 or later)
- [Foundry](https://github.com/foundry-rs/foundry)
- Ethereum wallet with some ETH on Base Sepolia

# Directory Layout

```
.
├── blockchain # Everything blockchain related
    |_ contracts # Contracts and the used interfaces
    |_ scripts # Deploy scripts
    |_ test # Automated tests
├── frontend # Frontend written in Next, wagmi, Rainbowkit
├── subgraph # The data source for the frontend
└── README.md
```

# Installation

Follow these steps to set up the project.

## Blockchain

### 1. Install dependencies:

```bash
cd ./blockchain && forge install
```

### 2. Create a `.env` file:

See `.env.example` in the `blockchain` folder for reference. Here are some explanation for each one of them:

- `RPC_URL`: The RPC url that will be used to deployed the smart contracts. By default, the project deploys smart contracts to Base's Sepolia testnet. You can change it to deploy to other networks.
- `PRIVATE_KEY`: The private key that will be used during the deployment. Remember to put some ETH into the first address generated by that key, otherwise you will see insufficient gas error.
- `IS_TESTING`: Set this to true if you want to try to swap the test tokens yourself after the deployment - the deployment script will seed the initial Oracle prices for each asset and the set the starting time for the trading competition to now.

### 3. Run tests and deploy contracts:

```bash
./test_and_deploy.sh
```

You will deploy 14 smart contracts with the command above. They're:

- 5 test tokens (wbtc, weth, usdt, usdc, dai)
- 5 oracles (one for each token)
- 1 Faucet for participants to request test tokens
- 1 UUPS Proxy
- 1 proxied Exchange
- 1 Exchange implementation

During the deployment, the scripts will show each one of them's address. Please write them down as we will use them in the following.

Note: If you encounter a permission denied error, run:

```bash
chmod +x test_and_deploy.sh
```

## Subgraph

At this point you should have the address for your DEX. You can now proceed to deploy a subgraph that you can use as the API for your UI.

There are lots of subgraph providers on the market. I will use [Alchemy](https://www.alchemy.com) in this section. Don't worry it's free for test purposes!

### 1. Install Graph CLI globally:

```bash
npm i -g @graphprotocol/graph-cli@0.73.0
```

### 2. Initialize the subgraph: \

Next, change the directory to `subgraph` in your terminal and run `graph init oracle-based-spot-dex --allow-simple-name` to initialize the package's CLI wizard and select the following options:

1.  Protocol: ethereum
2.  Product for which to initialize: hosted-service
3.  Subgraph name: oracle-based-spot-dex
4.  Directory to create the subgraph in: ./v1
5.  Ethereum network: base-sepolia
6.  Contract address: [PUT YOUR EXCHANGE ADDRESS HERE - NOT ExchangeProxy or ExchangeV1]
7.  Do you want to retry: N
8.  ABI file (path): ../frontend/public/abis/exchange.json
9.  Start Block: [Enter]
10. Contract Name: ExchangeV1
11. Index contract events as entities: true

### 3. Deploy the subgraph:

1.  Type `cd v1` to enter the subgraph.
2.  Run `graph build` to build the subgraph.
3.  Head to [Alchemy Subgraphs' dashboard](https://subgraphs.alchemy.com/onboarding) and click Deploy via CLI
4.  Copy and paste the command from previous step to deploy the subgraph. The command should look something like below

````bash
graph deploy example-subgraph-name \
--version-label v0.0.1-new-version \
--node https://subgraphs.alchemy.com/api/subgraphs/deploy \
--deploy-key  \
--ipfs https://ipfs.satsuma.xyz```
````

You should be able to see the newly deployed subgraph on [Alchemy Subgraphs' dashboard](https://subgraphs.alchemy.com/onboarding) now. **Enter that subgraph's page and copy the graphQL API for live version** - we will use it in the next section.

## Frontend

### 1. Install dependencies:

```bash
npm install
```

### 2. Create .env and

Similar previous sections, you need to create a `.env` for this folder. You can use the `.env.example` in the `frontend` folder as the reference.

### 3. Modify existing tokens.json

Besides the `.env` file, you also need to work on the `tokens.json` by putting the addresses you generated before into the file. By default, the `tokenDecimal` will be 18 and `oracleDecimal` be 8.

### 4. Start the Website

Now, you're all set. Run `npm run dev` to run the website and request the test tokens by clicking the water droplet image on the UI (and sending an on-chain transaction).

# What's Next

This repo contains the smart contracts and the UI to swap on the DEX and request test tokens from the faucet.
The only missing thing is the cron jobs that run on your backend to periodically update the Oracle prices on-chain for each token.
